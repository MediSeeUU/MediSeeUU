<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MediSee: Backend User Manual</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MediSee<span id="projectnumber">&#160;1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_medctrl_backend_user_manual.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Backend User Manual </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="md_medctrl_backend_user_manual.html#devsetup">Development set-up</a></li>
<li><a class="el" href="md_medctrl_backend_user_manual.html#endpoints">Endpoints</a></li>
<li><a class="el" href="md_medctrl_backend_user_manual.html#adminpanel">Admin panel</a></li>
<li><a class="el" href="md_medctrl_backend_user_manual.html#addvariable">Adding variables</a></li>
</ul>
<p ><a class="anchor" id="devsetup"></a></p>
<h1><a class="anchor" id="autotoc_md25"></a>
Development set-up</h1>
<p >This setup guide is written with Ubuntu 20.04 in mind. Most of the steps will be the same for other operating systems. There are a few prerequisites that we assume are already setup. These include:</p>
<ul>
<li>A Python3.10 install</li>
<li>Access to a MySQL database</li>
</ul>
<p >If the prerequisites are installed you can follow the guide below to get started.</p>
<p >In all the snippets below the current directory is <code>medctrl-backend/</code> unless specified otherwise.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Install dependencies</h2>
<p >0. Create and activate Python virtual environment. </p><pre class="fragment">```sh
python3 -m virtualenv venv
source venv/bin/activate
```
</pre><ol type="1">
<li><p class="startli">Install requirements.</p>
<div class="fragment"><div class="line">pip install -r requirements.txt</div>
</div><!-- fragment --><p class="startli">During the installation of <code>mysqlclient</code> an error might occur because some libraries are not yet installed. These can be installed with the following command:</p>
<div class="fragment"><div class="line">sudo apt install python3-dev default-libmysqlclient-dev build-essential</div>
</div><!-- fragment --></li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="autotoc_md27"></a>
Setup Configuration</h2>
<p >The configuration files for the software should be placed in <code>medctrl-backend/API/api_settings/settings/</code>. There already is a settings file (<code>common.py</code>) with general settings that are the same for every deployment. <br  />
 In addition to these settings you will need some extra configuration values, for example database login credentials. For development you should create a file named <code>dev_settings.py</code> in the <code>settings/</code> directory. \ Below is an example configuration which you can use as a template.</p>
<div class="fragment"><div class="line"><span class="comment"># Import all common settings</span></div>
<div class="line"><span class="keyword">from</span> <a class="code hl_namespace" href="namespaceapi__settings_1_1settings_1_1common.html">api_settings.settings.common</a> <span class="keyword">import</span> *</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Secret key that Django uses for generating hashes</span></div>
<div class="line">SECRET_KEY = <span class="stringliteral">&quot;random secret key&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Whether to run Django in Debug mode</span></div>
<div class="line">DEBUG = <span class="keyword">True</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Root path where the API will be listening on</span></div>
<div class="line">BASE_URL = <span class="stringliteral">&quot;api/&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Database connnection settings</span></div>
<div class="line"><span class="comment"># The DB credentials can be hardcoded or loaded in </span></div>
<div class="line"><span class="comment"># via environment variables </span></div>
<div class="line">DATABASES = {</div>
<div class="line">    <span class="stringliteral">&quot;default&quot;</span>: {</div>
<div class="line">        <span class="stringliteral">&quot;ENGINE&quot;</span>: <span class="stringliteral">&quot;django.db.backends.mysql&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;NAME&quot;</span>: DB_NAME,</div>
<div class="line">        <span class="stringliteral">&quot;USER&quot;</span>: DB_USERNAME,</div>
<div class="line">        <span class="stringliteral">&quot;PASSWORD&quot;</span>: DB_PASSWORD,</div>
<div class="line">        <span class="stringliteral">&quot;HOST&quot;</span>: DB_HOST,</div>
<div class="line">        <span class="stringliteral">&quot;PORT&quot;</span>: DB_PORT,</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Where to put static files for django. Not needed for development</span></div>
<div class="line">STATIC_ROOT = <span class="stringliteral">&quot;django-static&quot;</span></div>
<div class="ttc" id="anamespaceapi__settings_1_1settings_1_1common_html"><div class="ttname"><a href="namespaceapi__settings_1_1settings_1_1common.html">api_settings.settings.common</a></div><div class="ttdef"><b>Definition:</b> common.py:1</div></div>
</div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="autotoc_md28"></a>
MedCtrl Setup</h2>
<ol type="1">
<li>Migrate database and create Django permission levels</li>
</ol>
<div class="fragment"><div class="line"># in directory medctrl-backend/API</div>
<div class="line">python manage.py migrate</div>
<div class="line">python manage.py create_column_permissions</div>
</div><!-- fragment --><ol type="1">
<li>Create a Django admin user and anonymous group. <br  />
 To actually get data back, you need to assign permissions to this anonymous group. This can be done via the Django admin panel. <br  />
 More details about permissions can be found in the 'Managing Groups' section of this manual. <br  />
</li>
</ol>
<div class="fragment"><div class="line"># in directory medctrl-backend/API</div>
<div class="line"># this command will give some prompts for username and password</div>
<div class="line">python manage.py createsuperuser</div>
<div class="line">python manage.py init_setup</div>
</div><!-- fragment --><ol type="1">
<li>Run the backend</li>
</ol>
<div class="fragment"><div class="line"># in directory medctrl-backend/API</div>
<div class="line"># Django will start on port 8000</div>
<div class="line">python manage.py runserver 8000</div>
</div><!-- fragment --><div style="page-break-after: always;"></div><p ><a class="anchor" id="endpoints"></a></p>
<h1><a class="anchor" id="autotoc_md29"></a>
Endpoints</h1>
<ul>
<li>GET <code>/medicine</code>\ This endpoint is used to retrieve the medicine data. A GET request to this endpoint will return all the data that the (anonymous) user has access to.</li>
<li>GET <code>/procedure/{eunumber}</code> This endpoint is used to retrieve all the procedures that are connected to the medicine with the given eunumber.</li>
<li><code>/saveselection</code> \ This endpoint is used to create, retrieve and delete saved selections.<ul>
<li><p class="startli">Creating a saved selection \ POST <code>/saveselection</code> with following body:</p>
<p class="startli">```json { "name": "Name of selection", "eunumbers": [1, 2, 3] // list of selected medicines } ```</p>
<p class="startli">-&gt;</p>
<p class="startli">```json { "id": "12fb0250-a725-462d-8b06-92762194a2af", // id of the saved selection "name": "test", "created_at": "2022-06-15T11:11:59.466733Z", "created_by": "&lt;username&gt;", "eunumbers": [ 1, 2, 3 ] } ```</p>
</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><ul>
<li><p class="startli">Retrieving a single saved selection \ GET <code>/saveselection/&lt;selectionid&gt;</code>\ -&gt;</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;id&quot;: &quot;12fb0250-a725-462d-8b06-92762194a2af&quot;, // id of the saved selection</div>
<div class="line">    &quot;name&quot;: &quot;test&quot;,</div>
<div class="line">    &quot;created_at&quot;: &quot;2022-06-15T11:11:59.466733Z&quot;,</div>
<div class="line">    &quot;created_by&quot;: &quot;&lt;username&gt;&quot;,</div>
<div class="line">    &quot;eunumbers&quot;: [</div>
<div class="line">        1,</div>
<div class="line">        2,</div>
<div class="line">        3</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">Retrieving all saved selection for the current user \ GET <code>/savedselection</code> \ -&gt;</p>
<div class="fragment"><div class="line">[</div>
<div class="line">    {</div>
<div class="line">        &quot;id&quot;: &quot;12fb0250-a725-462d-8b06-92762194a2af&quot;, // id of the saved selection</div>
<div class="line">        &quot;name&quot;: &quot;test&quot;,</div>
<div class="line">        &quot;created_at&quot;: &quot;2022-06-15T11:11:59.466733Z&quot;,</div>
<div class="line">        &quot;created_by&quot;: &quot;&lt;username&gt;&quot;,</div>
<div class="line">        &quot;eunumbers&quot;: [</div>
<div class="line">            1,</div>
<div class="line">            2,</div>
<div class="line">            3</div>
<div class="line">        ]</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --></li>
<li>Deleting a saved selection \ DELETE <code>/saveselection/&lt;selectionid&gt;</code></li>
</ul>
<div style="page-break-after: always;"></div><ul>
<li>GET <code>/structureData</code> \ This endpoint returns details about the types of variables that are in the database. This data is, among other things, used to determine how to filter/sort the medicine data.</li>
<li><p class="startli">POST <code>/account/login</code> Used to login a user. POST with following body:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;username&quot;: &quot;username&quot;,</div>
<div class="line">    &quot;password&quot;: &quot;password&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">-&gt;</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;expiry&quot;: &quot;2022-06-15T21:11:51.454234Z&quot;,</div>
<div class="line">    &quot;token&quot;: &quot;1c5cd1a9cacb2a883059d1b835378eee71adb3112f61cf38fb88252cbdcdd026&quot;,</div>
<div class="line">    &quot;user&quot;: {</div>
<div class="line">        &quot;id&quot;: 2,</div>
<div class="line">        &quot;username&quot;: &quot;username&quot;,</div>
<div class="line">        &quot;groups&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;group1&quot;,</div>
<div class="line">                &quot;id&quot;: 1</div>
<div class="line">            }</div>
<div class="line">        ], // list of groups that the user is in</div>
<div class="line">        &quot;selections&quot;: [] // list of saved selection</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>POST <code>/account/logout</code>, <code>/account/logoutAll</code> \ These endpoints are used to logout the user. The <code>logoutAll</code> will end all active sessions of the given user. To logout, send a POST request with an empty body to one of these URLs.</li>
</ul>
<div style="page-break-after: always;"></div><ul>
<li><p class="startli">POST <code>/scraper/medicine</code> This endpoint can be used to programatically (for example via the scraper) update the medicine data in de database.</p>
<p class="startli">Updates can be done by sending a POST request with the following body\</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;override&quot;: true, // Whether to override manually updated values</div>
<div class="line">    &quot;data&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;eunumber&quot;: 1,</div>
<div class="line">            ...</div>
<div class="line">        } // A list of medicine objects that will be updated</div>
<div class="line">          // For a complete list of variables that can be updated</div>
<div class="line">          // See the domain model</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">POST <code>/scraper/procedure</code> This endpoint can be used to programatically (for example via the scraper) update the procedure data in de database.</p>
<p class="startli">Updates can be done by sending a POST request with the following body</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;override&quot;: true, // Whether to override manually updated values</div>
<div class="line">    &quot;data&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;eunumber&quot;: 1, </div>
<div class="line">            &quot;procedurecount&quot;: 1,</div>
<div class="line">            ...</div>
<div class="line">        } // A list of procedure objects that will be updated</div>
<div class="line">          // For a complete list of variables that can be updated</div>
<div class="line">          // See the domain model</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
<div style="page-break-after: always;"></div><p ><a class="anchor" id="adminpanel"></a></p>
<h1><a class="anchor" id="autotoc_md30"></a>
Admin panel</h1>
<p >The Django admin panel is accessible via the <code>&lt;ROOT_URL&gt;/admin/</code> endpoint.</p>
<p ><img src="img/admin_index.png" alt="Django admin panel index" class="inline"/></p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="autotoc_md31"></a>
Importing data from existing Excel sheets</h2>
<p >We have curated the initial dataset into Excel files that can be imported to the system. \ The data files can be found at <code>medctrl-backend/curated_data/</code>. Clicking on a model in the Admin panel will show import and export options in the top-right: <img src="img/admin_upload_file.png" alt="Django admin panel import export" class="inline"/></p>
<p >After submitting a file you will get an overview of the data that will be imported. You can then click confirm to actually import the data. \ Please note that importing the Procedures can take quite some time because it is a lot of data. (the 41k procedures took around 2-3 minutes to imoprt on a basic VM)</p>
<h2><a class="anchor" id="autotoc_md32"></a>
Scraper API keys</h2>
<p >In the admin panel you can generate an API key for the scraper. You can specify how many days the API key should be valid for and upon clicking generate you will be given the token which can be copied to the scraper.</p>
<p ><img src="img/admin_scraper_key.png" alt="Django admin genreate scraper key" class="inline"/> <img src="img/admin_scraper_generated.png" alt="Generate key success" class="inline"/> </p><div style="page-break-after: always;"></div><h2><a class="anchor" id="autotoc_md33"></a>
Manually update model values</h2>
<p >It is possible to update individual objects values in the admin panel by following the links in the overview.</p>
<p ><img src="img/admin_overview_update.png" alt="Admin update objects" class="inline"/></p>
<p >You will then be presented with an overview of all the objects that are in the database.</p>
<p ><img src="img/admin_med_objects.png" alt="Admin medicine objects list" class="inline"/></p>
<div style="page-break-after: always;"></div><p> Clicking on a medicine object will give options to edit or delete the object.</p>
<p ><img src="img/admin_med_edit.png" alt="Admin edit individual medicine" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md34"></a>
Group management</h2>
<p >We use groups to manage permissions. Groups can be managed via the admin panel.</p>
<p ><img src="img/admin_group_users.png" alt="Admin group and user management" class="inline"/></p>
<p >By default the initial setup script will create an anonymous group. If someone who is not logged in sends a request, the anonymous groups' permissions will be used to determine what data to send back. \ In the edit menu for a group you can specify which variables of a medicine a specific group has access to.</p>
<p ><img src="img/admin_group_permissions.png" alt="edit group permissions" class="inline"/></p>
<p >It is possible to create as many new groups as needed. On the users' page you can assign groups to users.</p>
<p ><img src="img/admin_user_group.png" alt="Assign groups to user" class="inline"/></p>
<div style="page-break-after: always;"></div><p> It is also possible to assign permissions to individual users.</p>
<p ><img src="img/admin_user_permissions.png" alt="User permissions" class="inline"/> </p><div style="page-break-after: always;"></div><p ><a class="anchor" id="addvariable"></a></p>
<h1><a class="anchor" id="autotoc_md35"></a>
Adding variables</h1>
<p >To add a new variable to the system there are a few things that need to be done:</p>
<ul>
<li>Add a new column to the appropriate model: \ models are located in the <code>API/api/models/</code> folder.\ To add a variable with name <code>X</code> to medicine for example you need to add a field <code>X</code> to the the <code>Medicine</code> model class in <code>medicine.py</code>. For more details on what types or relations are available please see the <a href="https://docs.djangoproject.com/en/4.0/ref/models/fields/">Django documentation</a></li>
<li><p class="startli">Add an entry to <code>API/views/other/medicine_info_json.py</code> \ In here you should specify what type the variable has and what the displayname should be. This is, among other things, used by the frontend to determine how to sort on this variable. An example entry would be: <br  />
</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;data-key&quot;: &quot;X&quot;,</div>
<div class="line">    &quot;data-front-key&quot;: &quot;X&quot;,</div>
<div class="line">    &quot;data-format&quot;: &quot;string&quot;,</div>
<div class="line">    &quot;data-value&quot;: &quot;Display name for frontend&quot;,</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">Create a new migration and migrate the database \ Run the following commands to migrate the new changes:</p>
<div class="fragment"><div class="line"># in directory medctrl-backend/API</div>
<div class="line">python manage.py makemigrations</div>
<div class="line">python manage.py migrate</div>
<div class="line">python manage.py create_column_permissions</div>
</div><!-- fragment --> <div style="page-break-after: always;"></div></li>
</ul>
<h1><a class="anchor" id="autotoc_md36"></a>
User management</h1>
<p >Normal users can be created in the Django admin panel. <br  />
 <img src="img/create_user.png" alt="Create user" class="inline"/></p>
<p >Once you have created a user you can assign groups and permissions to that user in the admin panel. <br  />
</p>
<p >The response of sending a login request (more details can be found in the 'Endpoints' section of this manual) contains a <code>token</code> key. This token is used to authenticate follwing requests. <br  />
 The token needs to be send in the <code>Authorization</code> header. <br  />
 The value of the headers should be: <code>Token &lt;token&gt;</code>, where <code>&lt;token&gt;</code> is the value that was returned with the login response. <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
