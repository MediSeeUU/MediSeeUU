<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MediSee: deployment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MediSee<span id="projectnumber">&#160;1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_medctrl_backend_deployment_deployment.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">deployment </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md5"></a>
Deployment of MedCtrl backend</h1>
<ul>
<li><a class="el" href="md_medctrl_backend_deployment_deployment.html#general">General info</a></li>
<li><a class="el" href="md_medctrl_backend_deployment_deployment.html#initSetup">Initial setup</a></li>
<li><a class="el" href="md_medctrl_backend_deployment_deployment.html#configuration">Configuration</a></li>
<li><a class="el" href="md_medctrl_backend_deployment_deployment.html#build">Build</a></li>
<li><a class="el" href="md_medctrl_backend_deployment_deployment.html#deploy">Deploy</a></li>
</ul>
<p ><a class="anchor" id="general"></a></p>
<h1><a class="anchor" id="autotoc_md6"></a>
General info</h1>
<p >The build and deploy system allows you to easily deploy a new version of the software without tampering with too many files. There is some initial setup that needs to be done, but once that is done the updating should be as easy as just running the <code>build.sh</code> script with an environment variable set.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Overview</h2>
<p >Every build has a buildname. This buildname is used to differentiate between different versions/configurations of the software. This buildname is used in a few places:</p>
<ul>
<li>It is used to determine where the build files will be copied to. Every build will have its own directory in <code>/opt/medctrl/backend</code>. This is also the place where the socket will be placed through which the application can communicate with Nginx (See <a class="el" href="md_medctrl_backend_deployment_deployment.html#deploy">Deploy</a> for more details).</li>
<li>It is used to choose which configuration file to use. So if you have <code>BUILD_NAME</code> set to <code>development</code>, the build script will set <code>API/api_settings/settings/deploy_development.py</code> as the configuration file to choose for this specific build. (See <a class="el" href="md_medctrl_backend_deployment_deployment.html#configuration">Configuration</a> for more details).</li>
<li>It is used to start/stop/restart the medctrl service. This is done by passing the name of the build as an <code>@</code> argument to the systemctl service that is running. If you have a build named <code>development</code> you can edit the service using the following commands:<ul>
<li><code>sudo systemctl stop medctrl@development</code> to stop</li>
<li><code>sudo systemctl start medctrl@development</code> to start</li>
<li><code>sudo systemctl restart medctrl@development</code> to restart</li>
</ul>
</li>
</ul>
<p ><a class="anchor" id="initSetup"></a></p>
<h1><a class="anchor" id="autotoc_md8"></a>
Inital setup</h1>
<p >This section will describe the one time setup that needs to be done to allow for a streamlined build/deploy process.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Used software</h2>
<p >This guide is written for Ubuntu 20.04. The following software should be installed: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Software   </th><th class="markdownTableHeadNone">Version    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Nginx   </td><td class="markdownTableBodyNone">1.18.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">python3   </td><td class="markdownTableBodyNone">3.10.4    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">npm   </td><td class="markdownTableBodyNone">8.5.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">node   </td><td class="markdownTableBodyNone">16.14.2    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MySQL server   </td><td class="markdownTableBodyNone">8.0.28   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md10"></a>
Prerequisites</h2>
<p >We assume some things are already setup before building/deployment of the system:</p>
<ol type="1">
<li>There is already a MySQL database setup to which you have login credentials. <a href="https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-20-04">Link to setup instructions</a></li>
<li>There is already a basic Nginx setup available. Adding endpoints for the MedCtrl system is covered in <a class="el" href="md_medctrl_backend_deployment_deployment.html#deploy">Deploy</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md11"></a>
Application setup</h2>
<p >At this stage we will create a directory where all the build files will live. We will also create a Unix service that will run the actual application. This Unix service will be modular, so it is possible to have multiple versions/environments running at the same time.</p>
<ol type="1">
<li><p class="startli">Create a folder where the builds will live:</p>
<div class="fragment"><div class="line">mkdir -p /opt/medctrl/backend</div>
<div class="line">mkdir -p /var/www/medctrl/django-static</div>
</div><!-- fragment --><p class="startli">Any builds that you run will end up in a subdirectory of this directory. So if you have a build with name <code>development</code> the build files will be placed in <code>/opt/medctrl/backend/development</code>.</p>
</li>
<li><p class="startli">Copy the <code>medctrl.target</code> and <code>medctrl@.service</code> files to the <code>/etc/systemd/system</code> directory:</p>
<div class="fragment"><div class="line"># in REPO_PATH/medctrl-backend/deployment</div>
<div class="line">cp medctrl.target /etc/systemd/system</div>
<div class="line">cp medctrl@.service /etc/systemd/system</div>
</div><!-- fragment --></li>
<li><p class="startli">Reload the systemctl-daemon:</p>
<div class="fragment"><div class="line">sudo systemctl daemon-reload</div>
</div><!-- fragment --></li>
</ol>
<p ><a class="anchor" id="configuration"></a></p>
<h1><a class="anchor" id="autotoc_md12"></a>
Configuration</h1>
<p >Every build should have a configuration file. This file is used to store deployment-specific configuration details such as database credentials.</p>
<p >The configuration file for a specific build should be placed in the <code>API/api_settings/settings/</code> directory. The name of the settings file should be: \ <code>deploy_${BUILD_NAME}.py</code>.</p>
<p >So if you have a buildname <code>development</code> the filename should be: \ <code>deploy_development.py</code>.</p>
<p >Below is a template with the keys that the configuration file should have, make sure to change the actual values before you deploy.</p>
<div class="fragment"><div class="line"><span class="keyword">from</span> <a class="code hl_namespace" href="namespaceapi__settings_1_1settings_1_1common.html">api_settings.settings.common</a> <span class="keyword">import</span> *</div>
<div class="line"> </div>
<div class="line">SECRET_KEY = <span class="stringliteral">&quot;random secret key&quot;</span></div>
<div class="line"> </div>
<div class="line">DEBUG = <span class="keyword">False</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># base url where the api will be served from</span></div>
<div class="line">BASE_URL = <span class="stringliteral">&quot;baseurl/&quot;</span></div>
<div class="line"> </div>
<div class="line">STATIC_ROOT = <span class="stringliteral">&quot;/var/www/medctrl/django-static&quot;</span></div>
<div class="line"> </div>
<div class="line">DATABASES = {</div>
<div class="line">    <span class="stringliteral">&quot;default&quot;</span>: {</div>
<div class="line">        <span class="stringliteral">&quot;ENGINE&quot;</span>: <span class="stringliteral">&quot;django.db.backends.mysql&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;NAME&quot;</span>: <span class="stringliteral">&quot;DATABASE_NAME&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;USER&quot;</span>: <span class="stringliteral">&quot;DATABASE_USER&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;PASSWORD&quot;</span>: <span class="stringliteral">&quot;DATABASE_PASSWORD&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;HOST&quot;</span>: <span class="stringliteral">&quot;DATABASE_HOST&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;PORT&quot;</span>: <span class="stringliteral">&quot;DATABASE_PORT&quot;</span>,</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceapi__settings_1_1settings_1_1common_html"><div class="ttname"><a href="namespaceapi__settings_1_1settings_1_1common.html">api_settings.settings.common</a></div><div class="ttdef"><b>Definition:</b> common.py:1</div></div>
</div><!-- fragment --><p ><a class="anchor" id="build"></a></p>
<h1><a class="anchor" id="autotoc_md13"></a>
Build</h1>
<p >The actual building of the software is handled in the <code>build.sh</code> script. This script will copy the source files to the build directory and install dependencies that are needed to run the project.</p>
<p >The <code>build.sh</code> script expects a environment variable <code>BUILD_NAME</code> to be set. This <code>BUILD_NAME</code> is used to differentiate between different versions/builds.</p>
<p >Below are steps to build and activate the software with a build name <code>development</code>:</p>
<p >0. Every build should have a configuration file, so make sure the <code>API/api_settings/deploy_development.py</code> file exists with the correct configuration values.</p>
<ol type="1">
<li><p class="startli">Run the <code>build.sh</code> script with environment variable set:</p>
<div class="fragment"><div class="line"># in REPO_PATH/medctrl-backend/</div>
<div class="line">BUILD_NAME=development ./build.sh</div>
</div><!-- fragment --></li>
<li><p class="startli">Anytime you have made a change to the system (or the configuration file) and want to update a running system you can re-run the <code>build.sh</code> script to update the build.</p>
<div class="fragment"><div class="line"># in REPO_PATH/medctrl-backend/</div>
<div class="line">BUILD_NAME=development ./build.sh</div>
</div><!-- fragment --></li>
</ol>
<p ><a class="anchor" id="deploy"></a></p>
<h1><a class="anchor" id="autotoc_md14"></a>
Deploy</h1>
<p >After the <code>build.sh</code> script is finished, the application runs on a Unix socket. Every build has a <code>gunicorn.sock</code> socket through which it can communicate. This socket can be used by by Nginx to serve requests. In a Nginx configuration file you can put a <code>location</code> block which points to the specific build. You can specify which endpoint is connected to which socket as follows:</p>
<div class="fragment"><div class="line"># ... Rest of nginx config file</div>
<div class="line"> </div>
<div class="line">    # The /api endpoint will be bound to the `development` build</div>
<div class="line">    location /api {</div>
<div class="line">        include proxy_params;</div>
<div class="line">        proxy_pass http://unix:/opt/medctrl/backend/development/gunicorn.sock;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    # The /testapi endpoint will be bound to the `testing` build</div>
<div class="line">    location /testapi {</div>
<div class="line">        include proxy_params;</div>
<div class="line">        proxy_pass http://unix:/opt/medctrl/backend/testing/gunicorn.sock;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    # This will serve the django frontend files (Used in the admin panel)</div>
<div class="line">    # This location block should be the same name as the folder name of the STATIC_ROOT variable in the config file. </div>
<div class="line">    location /django-static {</div>
<div class="line">        try_files $uri $uri/ =404;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"># ... Rest of nginx config file</div>
</div><!-- fragment --><p >After reloading Nginx using <code>nginx -s reload</code> the webserver should proxy all requests from <code>/api</code> to the running MedCtrl backend through the socket for the <code>development</code> build. All requests to <code>/testapi</code> will be proxied to the socket for the <code>testing</code> build. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
